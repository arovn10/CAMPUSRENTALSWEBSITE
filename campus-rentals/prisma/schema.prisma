// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String    @id @default(cuid())
  email                String    @unique
  firstName            String
  lastName             String
  password             String // Hashed password
  role                 UserRole  @default(INVESTOR)
  company              String?
  phone                String?
  isActive             Boolean   @default(true)
  emailVerified        Boolean   @default(false)
  emailVerifiedAt      DateTime?
  lastLoginAt          DateTime?
  loginAttempts        Int       @default(0)
  lockedUntil          DateTime?
  passwordResetToken   String?
  passwordResetExpires DateTime?
  twoFactorSecret      String?
  twoFactorEnabled     Boolean   @default(false)
  profileImage         String?
  address              String?
  city                 String?
  state                String?
  zipCode              String?
  country              String?
  dateOfBirth          DateTime?
  ssn                  String? // Encrypted
  emergencyContact     String?
  emergencyPhone       String?
  // Tax and K1 fields
  taxId                String? // Individual Tax ID / SSN (encrypted)
  entityName           String? // Entity name if investing through entity
  entityType           String? // Type of entity (LLC, S-Corp, Partnership, etc.)
  entityTaxId          String? // Entity Tax ID / EIN (encrypted)
  // Mailing address for K1s
  mailingAddress       String?
  mailingCity          String?
  mailingState         String?
  mailingZipCode       String?
  mailingCountry       String?   @default("US")
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  investments                Investment[]
  fundInvestments            FundInvestment[]
  distributions              Distribution[]
  documents                  Document[]
  notifications              Notification[]
  fundContributions          FundContribution[]
  fundDistributions          FundDistribution[]
  entities                   Entity[]
  uploadedDealPhotos         DealPhoto[]
  entityOwners               EntityOwner[]
  entityDistributions        EntityDistribution[]
  insurance                  Insurance[]
  propertyTaxes              PropertyTax[]
  waterfallTierDistributions WaterfallTierDistribution[]
  entityInvestmentOwners     EntityInvestmentOwner[]
  passwordResetTokens        PasswordResetToken[]
  emailVerificationTokens    EmailVerificationToken[]
  auditLogs                  AuditLog[]
  fileUploads                FileUpload[]
  propertyLoans              PropertyLoan[]
  propertyAccess             UserPropertyAccess[]
  contacts                   Contact[] // Contacts created by this user
  dealFollowers              DealFollower[] // Deals this user follows
  addedDealFollowers         DealFollower[]              @relation("DealFollowerAddedBy") // Deals this user granted access to
  dealFolders                DealFolder[] // Folders created by this user
  dealFiles                  DealFile[] // Files uploaded by this user
  assignedDeals              Deal[]                      @relation("DealAssignedTo") // Deals assigned to this user
  dealTasks                  DealTask[]                  @relation("TaskAssignedTo") // Tasks assigned to this user
  dealNotes                  DealNote[] // Notes created by this user
  dealRelationships          DealRelationship[] // Relationships for deals
  dueDiligenceItems          DueDiligenceItem[]          @relation("DueDiligenceAssignedTo") // Due diligence items assigned to this user
  pipelineDealFiles          PipelineDealFile[]

  @@map("users")
}

model Property {
  id                         String        @id @default(cuid())
  propertyId                 Int           @unique // External property ID
  name                       String
  address                    String
  description                String?
  bedrooms                   Int
  bathrooms                  Int
  price                      Float
  squareFeet                 Int?
  propertyType               PropertyType  @default(SINGLE_FAMILY)
  acquisitionDate            DateTime?
  constructionCompletionDate DateTime?
  stabilizationDate          DateTime?
  acquisitionPrice           Float?
  constructionCost           Float?
  totalCost                  Float?
  debtAmount                 Float?
  debtDetails                String?
  currentValue               Float?
  occupancyRate              Float?
  monthlyRent                Float?
  otherIncome                Float?
  annualExpenses             Float?
  capRate                    Float?
  dealStatus                 DealStatus    @default(STABILIZED)
  fundingStatus              FundingStatus @default(FUNDED)
  isActive                   Boolean       @default(true)
  createdAt                  DateTime      @default(now())
  updatedAt                  DateTime      @updatedAt

  // Relations
  investments         Investment[]
  entityInvestments   EntityInvestment[]
  photos              PropertyPhoto[]
  dealPhotos          DealPhoto[]
  insurance           Insurance[]
  propertyTaxes       PropertyTax[]
  waterfallStructures WaterfallStructure[]
  loans               PropertyLoan[]
  userAccess          UserPropertyAccess[]
  followers           DealFollower[] // Followers who can view this deal
  dealFiles           DealFile[] // Files associated with this deal
  dealFolders         DealFolder[] // Folders for organizing deal files
  deals               Deal[] // CRM deals linked to this property

  @@map("properties")
}

model UserPropertyAccess {
  id         String   @id @default(cuid())
  userId     String
  propertyId String
  createdAt  DateTime @default(now())

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
  @@map("user_property_access")
}

model Fund {
  id          String   @id @default(cuid())
  name        String
  description String?
  fundType    FundType @default(REAL_ESTATE)
  targetSize  Float?
  currentSize Float    @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  fundInvestments   FundInvestment[]
  fundContributions FundContribution[]
  fundDistributions FundDistribution[]

  @@map("funds")
}

model Investment {
  id                          String           @id @default(cuid())
  userId                      String
  propertyId                  String
  investmentAmount            Float? // Optional for SPECTATOR type
  ownershipPercentage         Float? // Optional for SPECTATOR type
  investmentType              InvestmentType   @default(INVESTOR)
  status                      InvestmentStatus @default(ACTIVE)
  investmentDate              DateTime? // Optional for SPECTATOR type
  preferredReturn             Float?
  percentOfProceeds           Float?
  preferredDistributionMethod String?
  paymentMethod               String?
  externalSystem1             String?
  externalId                  String?
  investmentDescription       String?
  receivedDate                DateTime?
  createdAt                   DateTime         @default(now())
  updatedAt                   DateTime         @updatedAt

  // Relations
  user          User           @relation(fields: [userId], references: [id])
  property      Property       @relation(fields: [propertyId], references: [id])
  distributions Distribution[]

  @@map("investments")
}

model FundInvestment {
  id                  String           @id @default(cuid())
  userId              String
  fundId              String
  investmentAmount    Float
  ownershipPercentage Float?
  status              InvestmentStatus @default(ACTIVE)
  investmentDate      DateTime         @default(now())
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])
  fund Fund @relation(fields: [fundId], references: [id])

  @@map("fund_investments")
}

model Distribution {
  id               String           @id @default(cuid())
  investmentId     String
  userId           String
  amount           Float
  distributionDate DateTime
  distributionType DistributionType @default(RENTAL_INCOME)
  description      String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  investment Investment @relation(fields: [investmentId], references: [id])
  user       User       @relation(fields: [userId], references: [id])

  @@map("distributions")
}

// Waterfall Distribution Models
model WaterfallStructure {
  id          String   @id @default(cuid())
  propertyId  String?
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  property               Property?               @relation(fields: [propertyId], references: [id])
  waterfallTiers         WaterfallTier[]
  waterfallDistributions WaterfallDistribution[]

  @@map("waterfall_structures")
}

model WaterfallTier {
  id                   String            @id @default(cuid())
  waterfallStructureId String
  tierNumber           Int
  tierName             String
  tierType             WaterfallTierType
  priority             Int // Lower number = higher priority
  returnRate           Float? // For preferred returns
  catchUpPercentage    Float? // For catch-up tiers
  promotePercentage    Float? // For promote tiers
  isActive             Boolean           @default(true)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  // Relations
  waterfallStructure WaterfallStructure          @relation(fields: [waterfallStructureId], references: [id], onDelete: Cascade)
  tierDistributions  WaterfallTierDistribution[]

  @@map("waterfall_tiers")
}

model WaterfallTierDistribution {
  id                 String                    @id @default(cuid())
  waterfallTierId    String
  entityInvestmentId String?
  userId             String?
  distributionAmount Float
  distributionDate   DateTime
  distributionType   WaterfallDistributionType
  description        String?
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt

  // Relations
  waterfallTier    WaterfallTier     @relation(fields: [waterfallTierId], references: [id], onDelete: Cascade)
  entityInvestment EntityInvestment? @relation(fields: [entityInvestmentId], references: [id])
  user             User?             @relation(fields: [userId], references: [id])

  @@map("waterfall_tier_distributions")
}

model WaterfallDistribution {
  id                   String                    @id @default(cuid())
  waterfallStructureId String
  totalAmount          Float
  distributionDate     DateTime
  distributionType     WaterfallDistributionType
  description          String?
  isProcessed          Boolean                   @default(false)
  oldDebtAmount        Float? // For refinancing distributions - stores old debt amount
  oldDebtDetails       String? // For refinancing distributions - stores old debt details
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt

  // Relations
  waterfallStructure   WaterfallStructure    @relation(fields: [waterfallStructureId], references: [id], onDelete: Cascade)
  refinanceClosingFees RefinanceClosingFee[]

  @@map("waterfall_distributions")
}

// Stores detailed closing fee line items for refinance distributions
model RefinanceClosingFee {
  id                      String   @id @default(cuid())
  waterfallDistributionId String
  category                String
  amount                  Float
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relations
  waterfallDistribution WaterfallDistribution @relation(fields: [waterfallDistributionId], references: [id], onDelete: Cascade)

  @@map("refinance_closing_fees")
}

model FundContribution {
  id               String           @id @default(cuid())
  fundId           String
  userId           String
  amount           Float
  contributionDate DateTime
  contributionType ContributionType @default(CAPITAL_CALL)
  description      String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  fund Fund @relation(fields: [fundId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@map("fund_contributions")
}

model FundDistribution {
  id               String               @id @default(cuid())
  fundId           String
  userId           String
  amount           Float
  distributionDate DateTime
  distributionType FundDistributionType @default(PROFIT_DISTRIBUTION)
  description      String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  // Relations
  fund Fund @relation(fields: [fundId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@map("fund_distributions")
}

model Document {
  id                String       @id @default(cuid())
  title             String
  description       String?
  fileName          String
  filePath          String
  fileSize          Int
  mimeType          String
  documentType      DocumentType
  entityType        EntityType
  entityId          String
  isPublic          Boolean      @default(false)
  visibleToAdmin    Boolean      @default(true)
  visibleToManager  Boolean      @default(true)
  visibleToInvestor Boolean      @default(true)
  uploadedBy        String
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  // Relations
  user User @relation(fields: [uploadedBy], references: [id])

  @@map("documents")
}

model PropertyPhoto {
  id         String    @id @default(cuid())
  propertyId String
  photoUrl   String
  photoType  PhotoType @default(EXTERIOR)
  isPrimary  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  property Property @relation(fields: [propertyId], references: [id])

  @@map("property_photos")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model Entity {
  id                String     @id @default(cuid())
  name              String
  type              EntityType
  address           String?
  taxId             String?    // EIN for entities (Group DB)
  stateOfFormation  String?    // State of formation (Group DB)
  formationDate     DateTime?  // Date entity was formed (Group DB)
  contactPerson     String?
  contactEmail      String?
  contactPhone      String?
  isActive          Boolean    @default(true)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relations
  createdBy                      String
  user                           User                    @relation(fields: [createdBy], references: [id])
  entityInvestments              EntityInvestment[]
  entityOwners                   EntityOwner[]
  entityInvestmentOwnerInvestors EntityInvestmentOwner[] @relation("EntityToEntityInvestmentOwner")
  investmentsAsEntityInvestor    EntityOwner[]           @relation("EntityToEntityInvestor")

  @@map("entities")
}

model EntityInvestment {
  id                  String           @id @default(cuid())
  entityId            String
  propertyId          String
  investmentAmount    Float
  ownershipPercentage Float
  status              InvestmentStatus @default(ACTIVE)
  investmentDate      DateTime         @default(now())
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  // Relations
  entity                     Entity                      @relation(fields: [entityId], references: [id])
  property                   Property                    @relation(fields: [propertyId], references: [id])
  entityDistributions        EntityDistribution[]
  waterfallTierDistributions WaterfallTierDistribution[]
  entityInvestmentOwners     EntityInvestmentOwner[]

  @@map("entity_investments")
}

model EntityOwner {
  id                  String   @id @default(cuid())
  entityId            String
  userId              String?
  investorEntityId    String?
  ownershipPercentage Float
  investmentAmount    Float
  breakdown           Json? // Breakdown of entity member investments for this specific deal
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  entity         Entity  @relation(fields: [entityId], references: [id])
  user           User?   @relation(fields: [userId], references: [id])
  investorEntity Entity? @relation("EntityToEntityInvestor", fields: [investorEntityId], references: [id])

  @@map("entity_owners")
}

// Per-property owners for an entity investment (does not change global entity membership)
model EntityInvestmentOwner {
  id                  String   @id @default(cuid())
  entityInvestmentId  String
  userId              String?
  investorEntityId    String?
  ownershipPercentage Float
  investmentAmount    Float
  breakdown           Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  entityInvestment EntityInvestment @relation(fields: [entityInvestmentId], references: [id], onDelete: Cascade)
  user             User?            @relation(fields: [userId], references: [id])
  investorEntity   Entity?          @relation("EntityToEntityInvestmentOwner", fields: [investorEntityId], references: [id])

  @@map("entity_investment_owners")
}

model DealPhoto {
  id           String   @id @default(cuid())
  propertyId   String // Property/deal ID - photos are linked to the property, not individual investments
  photoUrl     String // S3 URL
  s3Key        String // S3 object key for deletion
  fileName     String
  description  String?
  displayOrder Int      @default(0) // Order for display
  isThumbnail  Boolean  @default(false) // Thumbnail photo for the deal
  fileSize     Int?
  mimeType     String?
  uploadedBy   String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  uploader User     @relation(fields: [uploadedBy], references: [id])

  @@index([propertyId])
  @@index([propertyId, displayOrder])
  @@map("deal_photos")
}

model EntityDistribution {
  id                 String           @id @default(cuid())
  entityInvestmentId String
  userId             String
  amount             Float
  distributionDate   DateTime
  distributionType   DistributionType @default(RENTAL_INCOME)
  description        String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  // Relations
  entityInvestment EntityInvestment @relation(fields: [entityInvestmentId], references: [id])
  user             User             @relation(fields: [userId], references: [id])

  @@map("entity_distributions")
}

model Insurance {
  id             String   @id @default(cuid())
  propertyId     String
  provider       String
  policyNumber   String
  annualPremium  Float
  coverageAmount Float
  renewalDate    DateTime
  notes          String?
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("insurance")
}

model PropertyTax {
  id                String   @id @default(cuid())
  propertyId        String
  taxYear           Int
  annualPropertyTax Float
  notes             String?
  createdBy         String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("property_taxes")
}

model PropertyLoan {
  id                String      @id @default(cuid())
  propertyId        String
  lenderName        String // e.g., "Metairie Bank", "JD Bank", "Planters Bank"
  accountNumber     String? // Account number or loan identifier
  originalAmount    Float // Original loan amount when first taken
  currentBalance    Float // Current outstanding balance
  interestRate      Float? // Annual interest rate (e.g., 5.5 for 5.5%)
  loanDate          DateTime? // Date loan was originated
  maturityDate      DateTime? // Loan maturity date
  monthlyPayment    Float? // Monthly payment amount
  loanType          String? // e.g., "Mortgage", "Construction Loan", "Line of Credit"
  paymentType       PaymentType @default(AMORTIZING) // Interest-Only vs Amortizing
  amortizationYears Int? // Amortization term in years when amortizing
  isActive          Boolean     @default(true)
  notes             String? // Additional notes about the loan
  createdBy         String
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("property_loans")
}

// Enums
enum UserRole {
  ADMIN
  INVESTOR
  MANAGER
}

enum PropertyType {
  SINGLE_FAMILY
  MULTI_FAMILY
  COMMERCIAL
  MIXED_USE
  LAND
}

enum FundType {
  REAL_ESTATE
  PRIVATE_EQUITY
  VENTURE_CAPITAL
  HEDGE_FUND
}

enum InvestmentStatus {
  ACTIVE
  SOLD
  FORECLOSED
  PENDING
}

enum InvestmentType {
  INVESTOR
  SPECTATOR
}

enum DistributionType {
  RENTAL_INCOME
  SALE_PROCEEDS
  REFINANCE
  INSURANCE_SETTLEMENT
  OTHER
}

enum ContributionType {
  CAPITAL_CALL
  ADDITIONAL_INVESTMENT
  ROLLOVER
}

enum FundDistributionType {
  PROFIT_DISTRIBUTION
  RETURN_OF_CAPITAL
  SALE_PROCEEDS
  OTHER
}

enum DocumentType {
  RECEIPT
  EXPENSE
  OFFERING_MEMORANDUM
  OPERATING_AGREEMENT
  PPM
  FINANCIAL_STATEMENT
  TAX_DOCUMENT
  INSURANCE
  TITLE_REPORT
  APPRAISAL
  ENVIRONMENTAL_REPORT
  CONTRACT
  OTHER
}

enum EntityType {
  PROPERTY
  FUND
  USER
  LLC
  CORPORATION
  PARTNERSHIP
  TRUST
  OPERATOR
}

enum PhotoType {
  EXTERIOR
  INTERIOR
  AERIAL
  FLOOR_PLAN
  OTHER
}

enum NotificationType {
  DISTRIBUTION
  DOCUMENT_UPLOAD
  PROPERTY_UPDATE
  FUND_UPDATE
  SYSTEM
}

enum WaterfallTierType {
  PREFERRED_RETURN
  CATCH_UP
  PROMOTE
  RESIDUAL
  RETURN_OF_CAPITAL
}

enum WaterfallDistributionType {
  RENTAL_INCOME
  SALE_PROCEEDS
  REFINANCE
  INSURANCE_SETTLEMENT
  RETURN_OF_CAPITAL
  PREFERRED_RETURN
  PROMOTE
  OTHER
}

// Deal lifecycle and funding status
enum DealStatus {
  STABILIZED
  UNDER_CONSTRUCTION
  UNDER_CONTRACT
  SOLD
}

enum FundingStatus {
  FUNDED
  FUNDING
}

// Loan payment style
enum PaymentType {
  IO
  AMORTIZING
}

// Authentication and Security Models
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verification_tokens")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  resource   String
  resourceId String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

// File Management Models
model FileUpload {
  id           String       @id @default(cuid())
  userId       String
  fileName     String
  originalName String
  filePath     String
  fileSize     Int
  mimeType     String
  fileHash     String       @unique
  category     FileCategory
  isPublic     Boolean      @default(false)
  metadata     Json?
  uploadedAt   DateTime     @default(now())
  expiresAt    DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("file_uploads")
}

model FileShare {
  id          String          @id @default(cuid())
  fileId      String
  sharedBy    String
  sharedWith  String?
  shareToken  String          @unique
  permissions FilePermissions
  expiresAt   DateTime?
  createdAt   DateTime        @default(now())

  @@map("file_shares")
}

// Email and Notification Models
model EmailTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  subject     String
  htmlContent String
  textContent String?
  variables   Json?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("email_templates")
}

model EmailLog {
  id           String      @id @default(cuid())
  to           String
  from         String
  subject      String
  templateId   String?
  status       EmailStatus
  sentAt       DateTime?
  errorMessage String?
  metadata     Json?
  createdAt    DateTime    @default(now())

  @@map("email_logs")
}

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  category    String?
  isEncrypted Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

// Additional Enums
enum FileCategory {
  DOCUMENT
  IMAGE
  VIDEO
  AUDIO
  ARCHIVE
  SPREADSHEET
  PRESENTATION
  OTHER
}

enum FilePermissions {
  READ
  WRITE
  DELETE
  SHARE
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
}

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
  EMAIL_VERIFY
  FILE_UPLOAD
  FILE_DOWNLOAD
  FILE_DELETE
}

// Contact directory for non-investor contacts (bankers, advisors, etc.)
model Contact {
  id        String   @id @default(cuid())
  firstName String
  lastName  String
  email     String?
  phone     String?
  company   String?
  title     String?
  address   String?
  city      String?
  state     String?
  zipCode   String?
  country   String?  @default("US")
  notes     String?
  tags      String[] // e.g., ["Banker", "Advisor", "Attorney"]
  createdBy String // User who created this contact
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  creator           User               @relation(fields: [createdBy], references: [id])
  dealFollowers     DealFollower[] // Deals this contact follows
  dealRelationships DealRelationship[] // Relationships in deals
  vendorRelationships VendorRelationship[]

  @@index([email])
  @@index([createdBy])
  @@map("contacts")
}

// Deal followers - non-investors who have access to view a deal
model DealFollower {
  id          String   @id @default(cuid())
  propertyId  String // The deal/property they follow
  contactId   String? // If following as a contact
  userId      String? // If following as a user (for existing users who aren't investors)
  accessLevel String   @default("VIEW_ONLY") // VIEW_ONLY, DOCUMENTS, etc.
  notes       String? // Why they have access
  addedBy     String // User who granted access
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  contact     Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  addedByUser User     @relation("DealFollowerAddedBy", fields: [addedBy], references: [id])

  @@unique([propertyId, contactId])
  @@unique([propertyId, userId])
  @@index([propertyId])
  @@index([contactId])
  @@index([userId])
  @@map("deal_followers")
}

// Deal-specific file management with folder support
model DealFolder {
  id             String   @id @default(cuid())
  propertyId     String // The deal/property this folder belongs to
  name           String
  parentFolderId String? // For nested folders
  description    String?
  createdBy      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  property     Property     @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  parentFolder DealFolder?  @relation("FolderHierarchy", fields: [parentFolderId], references: [id], onDelete: Cascade)
  subFolders   DealFolder[] @relation("FolderHierarchy")
  files        DealFile[]
  creator      User         @relation(fields: [createdBy], references: [id])

  @@index([propertyId])
  @@index([parentFolderId])
  @@map("deal_folders")
}

model DealFile {
  id           String   @id @default(cuid())
  propertyId   String // The deal/property this file belongs to
  folderId     String? // Optional folder organization
  fileName     String
  originalName String
  filePath     String // S3 URL or local path
  fileSize     Int
  mimeType     String
  description  String?
  uploadedBy   String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  property Property    @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  folder   DealFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  uploader User        @relation(fields: [uploadedBy], references: [id])

  @@index([propertyId])
  @@index([folderId])
  @@map("deal_files")
}

// CRM Deal Pipeline Models
model DealPipeline {
  id          String   @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  stages DealPipelineStage[]
  deals  Deal[]

  @@map("deal_pipelines")
}

model DealPipelineStage {
  id          String   @id @default(cuid())
  pipelineId  String
  name        String
  description String?
  order       Int // Order within pipeline
  color       String? // Hex color for Kanban display
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  pipeline DealPipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  deals    Deal[]

  @@index([pipelineId])
  @@map("deal_pipeline_stages")
}

model Deal {
  id                 String       @id @default(cuid())
  name               String
  dealType           DealType     @default(ACQUISITION)
  status             String       @default("NEW") // Custom status string
  priority           DealPriority @default(MEDIUM)
  pipelineId         String?
  stageId            String?
  propertyId         String? // Link to existing property if applicable
  description        String?
  // location field removed - not in database
  estimatedValue     Float?
  estimatedCloseDate DateTime?
  actualCloseDate    DateTime?
  source             String? // Where the deal came from
  assignedToId       String? // User assigned to manage this deal
  tags               String[] // Array of tag strings
  metadata           Json? // Additional flexible data
  // TermSheet Pipeline Fields
  section            String?      @default("ACQUISITION") // ACQUISITION, DEVELOPMENT, ASSET_MANAGEMENT
  underwritingData   Json? // Underwriting calculations and data
  dueDiligenceStatus String?      @default("NOT_STARTED") // NOT_STARTED, IN_PROGRESS, COMPLETED
  budgetedCost       Float?
  actualCost         Float?
  startDate          DateTime?
  completionDate     DateTime?
  occupancyRate      Float?
  noi                Float?
  capRate            Float?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  // Relations
  pipeline            DealPipeline?      @relation(fields: [pipelineId], references: [id])
  stage               DealPipelineStage? @relation(fields: [stageId], references: [id])
  property            Property?          @relation(fields: [propertyId], references: [id])
  assignedTo          User?              @relation("DealAssignedTo", fields: [assignedToId], references: [id])
  tasks               DealTask[]
  notes               DealNote[]
  relationships       DealRelationship[]
  dealTags            DealTag[]
  developmentTimelines DevelopmentTimeline[]
  budgetLineItems     BudgetLineItem[]
  underwritingDataRecords UnderwritingData[]
  dueDiligenceItems   DueDiligenceItem[]
  assetMetrics        AssetMetric[]
  vendorRelationships VendorRelationship[]
  pipelineDealFiles   PipelineDealFile[]

  @@index([pipelineId])
  @@index([stageId])
  @@index([propertyId])
  @@index([assignedToId])
  @@index([section])
  @@map("deals")
}

model PipelineDealFile {
  id           String   @id @default(cuid())
  dealId       String
  fileName     String   // Stored filename on disk
  originalName String
  filePath     String   // Relative path (e.g. local:pipeline-deals/dealId/xxx)
  fileSize     Int
  mimeType     String
  description  String?
  uploadedById String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  deal       Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  uploadedBy User @relation(fields: [uploadedById], references: [id])

  @@index([dealId])
  @@index([uploadedById])
  @@map("pipeline_deal_files")
}

model DealTask {
  id           String       @id @default(cuid())
  dealId       String
  title        String
  description  String?
  status       TaskStatus   @default(TODO)
  priority     TaskPriority @default(MEDIUM)
  dueDate      DateTime?
  assignedToId String?
  completedAt  DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  deal       Deal  @relation(fields: [dealId], references: [id], onDelete: Cascade)
  assignedTo User? @relation("TaskAssignedTo", fields: [assignedToId], references: [id])

  @@index([dealId])
  @@index([assignedToId])
  @@map("deal_tasks")
}

model DealNote {
  id          String   @id @default(cuid())
  dealId      String
  content     String
  isPrivate   Boolean  @default(false) // Private notes only visible to creator
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  deal      Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  createdBy User @relation(fields: [createdById], references: [id])

  @@index([dealId])
  @@index([createdById])
  @@map("deal_notes")
}

model DealRelationship {
  id        String   @id @default(cuid())
  dealId    String
  contactId String? // Link to Contact
  userId    String? // Link to User
  role      String // e.g., "Banker", "Attorney", "Broker", "Advisor"
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  deal    Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  contact Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user    User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([contactId])
  @@index([userId])
  @@map("deal_relationships")
}

model DealTag {
  id        String   @id @default(cuid())
  dealId    String
  tag       String
  createdAt DateTime @default(now())

  // Relations
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@unique([dealId, tag])
  @@index([dealId])
  @@index([tag])
  @@map("deal_tags")
}

// CRM Enums
enum DealType {
  ACQUISITION
  DEVELOPMENT
  REFINANCE
  DISPOSITION
  PARTNERSHIP
  OTHER
}

enum DealPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// TermSheet Pipeline Models
model DevelopmentTimeline {
  id           String   @id @default(cuid())
  dealId       String
  name         String
  startDate    DateTime
  endDate      DateTime
  status       String   @default("PLANNED") // PLANNED, IN_PROGRESS, COMPLETED, DELAYED
  dependencies String[] // Array of timeline IDs this depends on
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@map("development_timelines")
}

model BudgetLineItem {
  id             String   @id @default(cuid())
  dealId         String
  category       String   // e.g., "Construction", "Legal", "Marketing"
  description    String
  budgetedAmount Float
  actualAmount   Float?
  variance       Float?   // Calculated: actualAmount - budgetedAmount
  status         String   @default("PLANNED") // PLANNED, IN_PROGRESS, COMPLETED
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@map("budget_line_items")
}

model UnderwritingData {
  id                 String   @id @default(cuid())
  dealId             String
  propertyType       String?
  purchasePrice      Float?
  loanAmount         Float?
  loanRate           Float?
  loanTerm           Int?
  downPayment        Float?
  grossRent          Float?
  vacancyRate        Float?
  operatingExpenses  Float?
  noi                Float?
  capRate            Float?
  irr                Float?
  cashOnCash         Float?
  debtServiceCoverage Float?
  additionalData     Json?    // Flexible field for other metrics
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@map("underwriting_data")
}

model DueDiligenceItem {
  id           String   @id @default(cuid())
  dealId       String
  category     String   // e.g., "Legal", "Financial", "Physical", "Environmental"
  item         String   // Specific checklist item
  status       String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, BLOCKED
  assignedToId String?
  dueDate      DateTime?
  completedAt  DateTime?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  deal       Deal  @relation(fields: [dealId], references: [id], onDelete: Cascade)
  assignedTo User? @relation("DueDiligenceAssignedTo", fields: [assignedToId], references: [id])

  @@index([dealId])
  @@index([assignedToId])
  @@map("due_diligence_items")
}

model AssetMetric {
  id              String   @id @default(cuid())
  dealId          String
  metricDate      DateTime
  occupancyRate   Float?
  revenue         Float?
  expenses        Float?
  noi             Float?
  capRate         Float?
  debtService     Float?
  cashFlow        Float?
  additionalMetrics Json?  // Flexible field for other operational metrics
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@map("asset_metrics")
}

model VendorRelationship {
  id           String   @id @default(cuid())
  dealId       String
  contactId    String?  // Link to Contact if exists
  vendorName   String
  vendorType   String   // e.g., "Property Manager", "Contractor", "Lender", "Legal"
  contactPerson String?
  email        String?
  phone        String?
  services     String[] // Array of services provided
  rating       Int?     // 1-5 rating
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  deal    Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  contact Contact? @relation(fields: [contactId], references: [id])

  @@index([dealId])
  @@index([contactId])
  @@map("vendor_relationships")
}
